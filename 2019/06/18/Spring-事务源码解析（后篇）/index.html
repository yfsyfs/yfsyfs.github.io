<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Spring 事务源码解析（后篇） | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="缘起【4】中已经完成了从Spring IOC层面如何引入事务的问题, 本文接着完成从拦截器栈角度完成AOP源码分析的问题.">
<meta name="keywords" content="源码,后端,Spring,事务">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring 事务源码解析（后篇）">
<meta property="og:url" content="http://yoursite.com/2019/06/18/Spring-事务源码解析（后篇）/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="缘起【4】中已经完成了从Spring IOC层面如何引入事务的问题, 本文接着完成从拦截器栈角度完成AOP源码分析的问题.">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/06/18/Spring-事务源码解析（后篇）/1.png">
<meta property="og:updated_time" content="2019-06-19T07:17:15.111Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring 事务源码解析（后篇）">
<meta name="twitter:description" content="缘起【4】中已经完成了从Spring IOC层面如何引入事务的问题, 本文接着完成从拦截器栈角度完成AOP源码分析的问题.">
<meta name="twitter:image" content="http://yoursite.com/2019/06/18/Spring-事务源码解析（后篇）/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <!--<link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">-->
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">影法師の物語</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Spring-事务源码解析（后篇）" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/18/Spring-事务源码解析（后篇）/" class="article-date">
  <time datetime="2019-06-18T13:09:00.000Z" itemprop="datePublished">2019-06-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring 事务源码解析（后篇）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h3><p>【4】中已经完成了从Spring IOC层面如何引入事务的问题, 本文接着完成从拦截器栈角度完成AOP源码分析的问题.</p>
<a id="more"></a>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>下面的源码编号是接着【4】的.</p>
<p>其实源码17的第11行跟进去</p>
<p>org.springframework.transaction.interceptor.TransactionAspectSupport.createTransactionIfNecessary(PlatformTransactionManager, TransactionAttribute, String)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">createTransactionIfNecessary</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			PlatformTransactionManager tm, TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If no name specified, apply method identification as transaction name.</span></span><br><span class="line">		<span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; txAttr.getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			txAttr = <span class="keyword">new</span> DelegatingTransactionAttribute(txAttr) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> joinpointIdentification;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125; <span class="comment">// 第一件事情: 封装txAttr(一个RuleBasedTransactionAttribute，它实现了TransactionAttribute接口)为DelegatingTransactionAttribute（它也实现了TransactionAttribute接口）,为什么要封装? 我的理解是因为提供了可以获取joinpointIdentification的功能</span></span><br><span class="line"></span><br><span class="line">		TransactionStatus status = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tm != <span class="keyword">null</span>) &#123;</span><br><span class="line">				status = tm.getTransaction(txAttr); <span class="comment">// 第二件事情: 获取事务</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"Skipping transactional joinpoint ["</span> + joinpointIdentification +</span><br><span class="line">							<span class="string">"] because no transaction manager has been configured"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status); <span class="comment">// 第三件事情: 综合前两件事情得到TransactionInfo，说白了，TransactionInfo就是第二步得到的TransactionStatus和TransactionAttribute的综合体</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                     源码32</p>
<p>源码32的第一件事情没什么好讲的, 来看第二件事情,  即源码32的第18行——在（封装为DelegatingTransactionAttribute）txAttr和事务管理器tm（这里的实现是 DataSourceTransactionManager）都非空的情况下，调用事务管理器的getTransaction接口(此接口由PlatformTransactionManager接口定义). 跟进此方法. 来到</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(TransactionDefinition)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> TransactionStatus <span class="title">getTransaction</span> <span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">		Object transaction = doGetTransaction(); <span class="comment">// 第一件事情: 获取对应的事务实例,获取的是txObject</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Cache debug flag to avoid repeated checks.</span></span><br><span class="line">		<span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (definition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// Use defaults if no transaction definition given.</span></span><br><span class="line">			definition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isExistingTransaction(transaction)) &#123; <span class="comment">// 判断当前线程是否存在事务</span></span><br><span class="line">			<span class="comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></span><br><span class="line">			<span class="keyword">return</span> handleExistingTransaction(definition, transaction, debugEnabled); <span class="comment">// 如果当前线程已经存在事务，则转向嵌套事务的处理</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Check definition settings for new transaction.</span></span><br><span class="line">		<span class="keyword">if</span> (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidTimeoutException(<span class="string">"Invalid transaction timeout"</span>, definition.getTimeout());</span><br><span class="line">		&#125; <span class="comment">// 事务超时的处理</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span></span><br><span class="line">		<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">					<span class="string">"No existing transaction found for transaction marked with propagation 'mandatory'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">			SuspendedResourcesHolder suspendedResources = suspend(<span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Creating new transaction with name ["</span> + definition.getName() + <span class="string">"]: "</span> + definition);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">				DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">						definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">				doBegin(transaction, definition);</span><br><span class="line">				prepareSynchronization(status, definition);</span><br><span class="line">				<span class="keyword">return</span> status;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">				resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">				resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line">				<span class="keyword">throw</span> err;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Create "empty" transaction: no actual transaction, but potentially synchronization.</span></span><br><span class="line">			<span class="keyword">if</span> (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">				logger.warn(<span class="string">"Custom isolation level specified but no actual transaction initiated; "</span> +</span><br><span class="line">						<span class="string">"isolation level will effectively be ignored: "</span> + definition);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">			<span class="keyword">return</span> prepareTransactionStatus(definition, <span class="keyword">null</span>, <span class="keyword">true</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                            源码33</p>
<p>下面就上面的代码详细的分析. 其实Spring的架构就是这样——一个比较简端的函数入口(例如这里的源码33)，只是定义处理框架，具体的业务交给一些子函数取处理，这是Spring框架的特点.</p>
<p>来到源码33的第三行，跟进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">doGetTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		DataSourceTransactionObject txObject = <span class="keyword">new</span> DataSourceTransactionObject();</span><br><span class="line">		txObject.setSavepointAllowed(isNestedTransactionAllowed());</span><br><span class="line">		ConnectionHolder conHolder =</span><br><span class="line">				(ConnectionHolder) TransactionSynchronizationManager.getResource(<span class="keyword">this</span>.dataSource); <span class="comment">// 从当前线程获取connectionHolder</span></span><br><span class="line">		txObject.setConnectionHolder(conHolder, <span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">return</span> txObject;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                        源码34</p>
<p>其中DataSourceTransactionObject是</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataSource transaction object, representing a ConnectionHolder.Used as transaction object by DataSourceTransactionManager.</span><br></pre></td></tr></table></figure>
<p>即DataSourceTransactionObject是一个数据源事务对象，代表一个连接持有器，被DataSourceTransactionManager这种事务管理器使用.</p>
<p>第四行代码说的是txObject是否允许设置回滚点取决于是否允许嵌套事务（如果不允许嵌套 事务的话，显然就不允许设置回滚点，回滚点的应用场景之一就是有嵌套事务的存在）. 而DataSourceTransactionManager的nestedTransactionAllowed是true，这是DataSourceTransactionManager的无参构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DataSourceTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		setNestedTransactionAllowed(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new DataSourceTransactionManager instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> dataSource JDBC DataSource to manage transactions for</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DataSourceTransactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>();</span><br><span class="line">		setDataSource(dataSource);</span><br><span class="line">		afterPropertiesSet();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>而我们在项目的【1】的MainConfig中调用的就是上面的构造器. (其实nestedTransactionAllowed是DataSourceTransactionManager的父类AbstractPlatformTransactionManager的属性，默认是false的, 只是被DataSourceTransactionManager在其构造函数中修改了).</p>
<p>源码34的第五行的逻辑是</p>
<p>org.springframework.transaction.support.TransactionSynchronizationManager.getResource(Object)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Retrieve a resource for the given key that is bound to the current thread.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getResource</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br><span class="line">		Object value = doGetResource(actualKey);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Retrieved value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] bound to thread ["</span> +</span><br><span class="line">					Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                            源码35</p>
<p>和org.springframework.transaction.support.TransactionSynchronizationManager.doGetResource(Object)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Actually check the value of the resource that is bound for the given key.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">doGetResource</span><span class="params">(Object actualKey)</span> </span>&#123;</span><br><span class="line">		Map&lt;Object, Object&gt; map = resources.get();</span><br><span class="line">		<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Object value = map.get(actualKey);</span><br><span class="line">		<span class="comment">// Transparently remove ResourceHolder that was marked as void...</span></span><br><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</span><br><span class="line">			map.remove(actualKey);</span><br><span class="line">			<span class="comment">// Remove entire ThreadLocal if empty...</span></span><br><span class="line">			<span class="keyword">if</span> (map.isEmpty()) &#123;</span><br><span class="line">				resources.remove();</span><br><span class="line">			&#125;</span><br><span class="line">			value = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                        源码36</p>
<p>源码34 的第六行的dataSource是com.mchange.v2.c3p0.ComboPooledDataSource数据源，所以源码35、36中的key、actualKey也都是以数据源作为键. 源码36第一次来肯定map是null的.  所以源码36 的第七行就直接返回null了.源码35第八行也就是直接返回null了. 注意，源码35行的日志很有意思——</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Retrieved value [" + value + "] for key [" + actualKey + "] bound to thread [" +</span><br><span class="line">					Thread.currentThread().getName() + "]</span><br></pre></td></tr></table></figure>
<p>这明显的意思就是如果当前线程绑定了resource的话，就直接复用了. 其实源码35的注释也写清楚了.</p>
<p>回到源码34第七行，简单的设置了conHolder为null以及newConnectionHolder为false </p>
<p>最后源码34返回了txObject这个DataSourceTransactionManager中的DataSourceTransactionObject. 来到源码33的13行，判断是否存在事务，isExistingTransaction方法的逻辑很简单，就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isExistingTransaction</span><span class="params">(Object transaction)</span> </span>&#123;</span><br><span class="line">		DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</span><br><span class="line">		<span class="keyword">return</span> (txObject.hasConnectionHolder() &amp;&amp; txObject.getConnectionHolder().isTransactionActive());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>而这里的transaction入参就是源码33第三行得到的那个txObject. 那txObject.hasConnectionHolder()已经是false了，所以自然返回false. 即当前线程不存在事务（为啥说当前线程? 因为源码34到36的resources是一个ThreadLocal变量）.</p>
<p>来到源码33的第19行，即事务超时的处理，definition就是源码32第七行封装过的txAttr，它作为DelegatingTransactionAttribute的是实现了TransactionDefinition接口的.   而definition.getTimeout() &lt;与TransactionDefinition.TIMEOUT_DEFAULT都是-1，所以来到了源码33第24行. 这一行的意思是如果事务定义（definition其实就是封装过的txAttr）强制当前有事务，但是现在源码33第13行已经判定了没有事务</p>
<p>所以就不符合要求，就会抛出异常. 但是现在 txAttr中是PROPAGATION_REQUIRED，所以不会抛出异常. 来到源码33的28行，显然符合判断，即对于 PROPAGATION_REQUIRED、PROPAGATION_REQUIRES_NEW、PROPAGATION_NESTED都是需要新建事务的(因为源码33第13行已经判定了当前)</p>
<p>源码33的第31行是空挂起，因为传入的是null, 所以其实这个函数什么也没做.</p>
<p>即返回的suspendedResources为null（没有任何事务资源被挂起）</p>
<p>源码33 的36行和37行不是很清楚得到什么（估计要到源码33的40行才清楚）. 但是结果是newSynchronization为true.因为getTransactionSynchronization()得到的是0</p>
<p>下面来到重头戏——源码33的39行——doBegin(transaction, definition);,  第一个参数是txObject，第二个参数是封装过的txAttr.  可以说事务是从这个函数开始的 ，因为在这个函数中已经开始尝试了对数据库连接的获<br>取，当然，在获取数据库连接的同时 ， 一些必要的设置也是需要同步设置的 </p>
<p>下面跟进这个函数，总体而言，这个函数构造 transaction ， 包括设置ConnectionHolder 、 隔离级别、 timeout<br>并且如果是新连接 ， 则绑定到当前线程 </p>
<p>org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(Object, TransactionDefinition)</p>
<p>这个方法是org.springframework.transaction.support.AbstractPlatformTransactionManager定义的抽象方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * This implementation sets the isolation level but ignores the timeout.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBegin</span><span class="params">(Object transaction, TransactionDefinition definition)</span> </span>&#123;</span><br><span class="line">		DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</span><br><span class="line">		Connection con = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!txObject.hasConnectionHolder() ||</span><br><span class="line">					txObject.getConnectionHolder().isSynchronizedWithTransaction()) &#123;</span><br><span class="line">				Connection newCon = <span class="keyword">this</span>.dataSource.getConnection();</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"Acquired Connection ["</span> + newCon + <span class="string">"] for JDBC transaction"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				txObject.setConnectionHolder(<span class="keyword">new</span> ConnectionHolder(newCon), <span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			txObject.getConnectionHolder().setSynchronizedWithTransaction(<span class="keyword">true</span>);</span><br><span class="line">			con = txObject.getConnectionHolder().getConnection();</span><br><span class="line"></span><br><span class="line">			Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);</span><br><span class="line">			txObject.setPreviousIsolationLevel(previousIsolationLevel);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span></span><br><span class="line">			<span class="comment">// so we don't want to do it unnecessarily (for example if we've explicitly</span></span><br><span class="line">			<span class="comment">// configured the connection pool to set it already).</span></span><br><span class="line">			<span class="keyword">if</span> (con.getAutoCommit()) &#123;</span><br><span class="line">				txObject.setMustRestoreAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"Switching JDBC Connection ["</span> + con + <span class="string">"] to manual commit"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				con.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			prepareTransactionalConnection(con, definition);</span><br><span class="line">			txObject.getConnectionHolder().setTransactionActive(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> timeout = determineTimeout(definition);</span><br><span class="line">			<span class="keyword">if</span> (timeout != TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">				txObject.getConnectionHolder().setTimeoutInSeconds(timeout);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Bind the connection holder to the thread.</span></span><br><span class="line">			<span class="keyword">if</span> (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">				TransactionSynchronizationManager.bindResource(getDataSource(), txObject.getConnectionHolder());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">				DataSourceUtils.releaseConnection(con, <span class="keyword">this</span>.dataSource);</span><br><span class="line">				txObject.setConnectionHolder(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> CannotCreateTransactionException(<span class="string">"Could not open JDBC Connection for transaction"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                    源码37</p>
<p>第六行首先获取txAttr,  然后用他看看当前线程有没有ConnectionHolder，显然现在是没有的. 则来到第12行——从数据源（【1】中用的是C3P0的数据源）获取一个连接. 这个不在我们Spring考察的范围中. 于是我们获取到了</p>
<p>newCon=com.mchange.v2.c3p0.impl.NewProxyConnection@18a136ac 这样一个（新）连接.</p>
<p>看源码37的第16行，我们将用这个新的连接用ConnectionHolder封装一下，所谓封装的源码如下，是ConnectionHolder的构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new ConnectionHolder for the given JDBC Connection,</span></span><br><span class="line"><span class="comment">	 * wrapping it with a &#123;<span class="doctag">@link</span> SimpleConnectionHandle&#125;,</span></span><br><span class="line"><span class="comment">	 * assuming that there is no ongoing transaction.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connection the JDBC Connection to hold</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> SimpleConnectionHandle</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #ConnectionHolder(java.sql.Connection, boolean)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ConnectionHolder</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.connectionHandle = <span class="keyword">new</span> SimpleConnectionHandle(connection);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                            源码38</p>
<p>其实就是给ConnectionHolder的connectionHandle设置为一个connection为内核的SimpleConnectionHandle。</p>
<p>源码37的第16行的第二个参数newConnectionHolder设置为了true，即txObject（一个DataSourceTransactionObject）的属性.</p>
<p>经过源码37的第16行处理之后，txObject中已经有了ConnectionHolder. 即txObject.hasConnectionHolder不再是false了.</p>
<p>源码37的第19行设置了connectionHolder的synchronizedWithTransaction属性为true. 注意，源码37第10行的判断——我们不是每次都要去数据源获取新连接，而是并不是每次都会获取新的连接 ， 如果当前线程中的 connectionHolder 已经存在， 则没有必要再次获取，或者 ， 对于事务同步标识（即synchronizedWithTransaction）设置为 true 的需要重新获取连接 。 </p>
<p>注意，到了这里先小结一下</p>
<img src="/2019/06/18/Spring-事务源码解析（后篇）/1.png">
<p>即txObject里面有connectionHolder，connectionHolder里面有connectionHandler，connectionHandler里面有connection（源码38）.而且connectionHolder设置了事务同步标识为synchronizedWithTransaction为true.</p>
<p>源码37的20行拿出了我们刚刚从数据源获取的连接, 并且向txObject的connectionHolder的currentConnection设置了当前的数据库连接（其实就是connectionHolder的connectionHandler中的connection）.</p>
<p>来到源码37的第22行. prepareConnectionForTransaction这个名字顾名思义就是为这个事务(使用txAttr，也就是之前封装好的DelegatingTransactionAttribute)设置刚刚获取的连接（connection）的属性，这个connection是和数据库交互的.</p>
<p>讲到这里，基本就明白了——txObject中存放的是连接，而连接根据definition（也就是txAttr）来设置各种属性. 不信? 我们跟进prepareConnectionForTransaction的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Prepare the given Connection with the given transaction semantics.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> con the Connection to prepare</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> definition the transaction definition to apply</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the previous isolation level, if any</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> SQLException if thrown by JDBC methods</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #resetConnectionAfterTransaction</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">prepareConnectionForTransaction</span><span class="params">(Connection con, TransactionDefinition definition)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(con, <span class="string">"No Connection specified"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set read-only flag.</span></span><br><span class="line">		<span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; definition.isReadOnly()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"Setting JDBC Connection ["</span> + con + <span class="string">"] read-only"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				con.setReadOnly(<span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">				Throwable exToCheck = ex;</span><br><span class="line">				<span class="keyword">while</span> (exToCheck != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (exToCheck.getClass().getSimpleName().contains(<span class="string">"Timeout"</span>)) &#123;</span><br><span class="line">						<span class="comment">// Assume it's a connection timeout that would otherwise get lost: e.g. from JDBC 4.0</span></span><br><span class="line">						<span class="keyword">throw</span> ex;</span><br><span class="line">					&#125;</span><br><span class="line">					exToCheck = exToCheck.getCause();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// "read-only not supported" SQLException -&gt; ignore, it's just a hint anyway</span></span><br><span class="line">				logger.debug(<span class="string">"Could not set JDBC Connection read-only"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">				Throwable exToCheck = ex;</span><br><span class="line">				<span class="keyword">while</span> (exToCheck != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (exToCheck.getClass().getSimpleName().contains(<span class="string">"Timeout"</span>)) &#123;</span><br><span class="line">						<span class="comment">// Assume it's a connection timeout that would otherwise get lost: e.g. from Hibernate</span></span><br><span class="line">						<span class="keyword">throw</span> ex;</span><br><span class="line">					&#125;</span><br><span class="line">					exToCheck = exToCheck.getCause();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// "read-only not supported" UnsupportedOperationException -&gt; ignore, it's just a hint anyway</span></span><br><span class="line">				logger.debug(<span class="string">"Could not set JDBC Connection read-only"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Apply specific isolation level, if any.</span></span><br><span class="line">		Integer previousIsolationLevel = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Changing isolation level of JDBC Connection ["</span> + con + <span class="string">"] to "</span> +</span><br><span class="line">						definition.getIsolationLevel());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> currentIsolation = con.getTransactionIsolation();</span><br><span class="line">			<span class="keyword">if</span> (currentIsolation != definition.getIsolationLevel()) &#123;</span><br><span class="line">				previousIsolationLevel = currentIsolation;</span><br><span class="line">				con.setTransactionIsolation(definition.getIsolationLevel());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> previousIsolationLevel;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                    源码39</p>
<p>第15行对只读事务进行了设置，也就是说如果definition（即txAttr）中设置了当前事务是只读的（即从方法的@Transactional 注解中设置了只读）, 则我们就要设置connection为read-only的(源码39的20行).</p>
<p>你看，这不就应验了我刚刚说的——txObject中存放的connection连接根据txAttr中的属性进行设置吗? 所以txAttr是十分重要的——它代表了使用者希望连接具备什么样的属性. 来到源码50行，如果txAttr（即用户希望的）隔离级别不是ISOLATION_DEFAULT(用-1表示)的话，则返回过去的隔离级别并设置当前用户想设置的隔离级别.</p>
<p>注意，这里我多说一句，我不会去跟诸如 setTransactionIsolation 的源码. 因为那里不是Spring的源码. 而是各个数据源或者mysql实现的. 如果用户没有动事务的默认的隔离级别的话，例如本例（【1】）就是这样. 则返回previousIsolationLevel=null. 源码37的23行就对txObject设置了其previousIsolationLevel属性（自然也是null）.</p>
<p>源码37的28行判断了当前连接是不是自动提交的，显然是（mysql数据库就是这样），所以会进到源码37 的29行，设置txObject的mustRestoreAutoCommit属性为true. 即原本数据库的此连接是自动提交的（例如mysql）, 所以要保存一下. 而且看一下代码中做的事情就知道了——Switching JDBC Connection [“ + con + “] to manual commit。</p>
<p>最后源码37的33行设置了连接的自动提交为false——毕竟你要开启事务嘛~ 自然不能自动提交啦.</p>
<p>注意源码37的25行注释——转换手动提交对于某些jdbc驱动性能损耗是十分高的，所以源码37的28行要做一个判断——如果在某些连接池中已经设置了手动提交的话，就没必要进行后面的再设置了.</p>
<p>我们继续，我们来到源码37的36行，prepareTransactionalConnection，顾名思义就是准备事务连接，上面已经对connection进行了只读、隔离级别、自动提交等一系列属性进行了设置.  那么这里这个函数是做什么的?</p>
<p>跟进去</p>
<p>org.springframework.jdbc.datasource.DataSourceTransactionManager.prepareTransactionalConnection(Connection, TransactionDefinition)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Prepare the transactional &#123;<span class="doctag">@code</span> Connection&#125; right after transaction begin.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareTransactionalConnection</span><span class="params">(Connection con, TransactionDefinition definition)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isEnforceReadOnly() &amp;&amp; definition.isReadOnly()) &#123;</span><br><span class="line">			Statement stmt = con.createStatement();</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				stmt.executeUpdate(<span class="string">"SET TRANSACTION READ ONLY"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				stmt.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                        源码40</p>
<p>如果事务被设置为只读的，则整个事务先执行一条sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">TRANSACTION</span> <span class="keyword">READ</span> <span class="keyword">ONLY</span></span><br></pre></td></tr></table></figure>
<p>关于这条sql参见【5】，其实就是设置只读事务. 而现在显然不是只读事务，所以源码40本质上什么也没干就退出了.源码37的第37行设置了当前事务是活跃的. 即txObject的connectionHolder属性的transactionActive属性设置为true(Set whether this holder represents an active, JDBC-managed transaction.). 源码37的第39行得到timeout是-1，即用不超时. 源码37的40行表示如果txAttr（即用户想要的超时时间）和默认的”永不超时”不相等的话，则就要设置失效时间(源码37的41行). 设置的方法是</p>
<p>ResourceHolderSupport中的.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Set the timeout for this object in seconds.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> seconds number of seconds until expiration</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeoutInSeconds</span><span class="params">(<span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">		setTimeoutInMillis(seconds * <span class="number">1000L</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Set the timeout for this object in milliseconds.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> millis number of milliseconds until expiration</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeoutInMillis</span><span class="params">(<span class="keyword">long</span> millis)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.deadline = <span class="keyword">new</span> Date(System.currentTimeMillis() + millis);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>注意，源码37 的41行是对ConnectionHolder进行设置的，而ConnectionHolder是ResourceHolderSupport的子类，你懂了吧?</p>
<p>好了，来到了源码37的45行.  做的事情注释也写清楚了——Bind the connection holder to the thread. 绑定txObject中的ConnectionHolder和当前线程. 这里先做了一个判断，问是不是新建的ConnectionHolder？显然嘛~ 显然是新建的嘛 ~ 因为就是看txObject中的newConnectionHolder属性是不是true,  源码34的第七行我们就做了这件事情啦. 则源码37的46行，做的事情就是绑定数据源和txObject（其实就是数据源事务对象）的connectionHolder源码如下</p>
<p>TransactionSynchronizationManager中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindResource</span><span class="params">(Object key, Object value)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">		Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br><span class="line">		Assert.notNull(value, <span class="string">"Value must not be null"</span>);</span><br><span class="line">		Map&lt;Object, Object&gt; map = resources.get();</span><br><span class="line">		<span class="comment">// set ThreadLocal Map if none found</span></span><br><span class="line">		<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">			map = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">			resources.set(map);</span><br><span class="line">		&#125;</span><br><span class="line">		Object oldValue = map.put(actualKey, value);</span><br><span class="line">		<span class="comment">// Transparently suppress a ResourceHolder that was marked as void...</span></span><br><span class="line">		<span class="keyword">if</span> (oldValue <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) oldValue).isVoid()) &#123;</span><br><span class="line">			oldValue = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (oldValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already value ["</span> + oldValue + <span class="string">"] for key ["</span> +</span><br><span class="line">					actualKey + <span class="string">"] bound to thread ["</span> + Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Bound value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] to thread ["</span> +</span><br><span class="line">					Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                            源码41</p>
<p>注意，我们曾今在源码35中获取resource(getResource), 也是在TransactionSynchronizationManager 这个类中.</p>
<p>源码41的key是c3p0数据源，value是txObject的ConnectionHolder.  源码41的第四行毫无意外的得到了null. 所以第7行map进行了赋值——一个hashmap，然后塞进了这里的&lt;c3p0数据源，txObject的connectionHolder&gt;键值对. 所以这里我们就明白了，源码35中的getResource方法获取的是什么资源——就是txObject的connectionHolder! 而这个connectionHolder中有数据库连接，也有根据txAttr的信息写入的一系列事务信息.</p>
<p>至此，源码33的39行的doBegin的代码已经解析完毕，其实做的事情就是向数据源获取连接之后根据事务信息txAttr对连接进行各种设置. 然后绑定当前线程（确切讲，根据源码41，是一个map绑定了当前线程，map是使用c3p0数据源做key的, 则一根线程来取的时候，先取出map，然后根据数据源取出相应的connectionHolder, 里面有从该数据源获取的并根据txAttr设置好各种事务属性的连接）.</p>
<p>来到源码33 的第40行，即prepareSynchronization，顾名思义是处理事务同步的事情.</p>
<p>跟进去</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.prepareSynchronization(DefaultTransactionStatus, TransactionDefinition)  这是AbstractPlatformTransactionManager的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Initialize transaction synchronization as appropriate.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareSynchronization</span><span class="params">(DefaultTransactionStatus status, TransactionDefinition definition)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (status.isNewSynchronization()) &#123;</span><br><span class="line">			TransactionSynchronizationManager.setActualTransactionActive(status.hasTransaction());</span><br><span class="line">			TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(</span><br><span class="line">					definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT ?</span><br><span class="line">							definition.getIsolationLevel() : <span class="keyword">null</span>);</span><br><span class="line">			TransactionSynchronizationManager.setCurrentTransactionReadOnly(definition.isReadOnly());</span><br><span class="line">			TransactionSynchronizationManager.setCurrentTransactionName(definition.getName());</span><br><span class="line">			TransactionSynchronizationManager.initSynchronization();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码42</p>
<p>源码33的36行的作用就知道了——判断事务的同步属性.</p>
<p>上面源码42做的事情就是往一系列的TransactionSynchronizationManager的ThreadLocal属性中塞东西.</p>
<p>第六行塞的是事务是否活跃? doBegin（源码37的37行）中就已经设置为true了.</p>
<p>第10行是塞是否是只读事务</p>
<p>第11行是塞事务的名字，注意，因为传入的definition是txAttr, 而他在源码32的第七行就已经封装成了</p>
<p>DelegatingTransactionAttribute（里面实现了getName接口），所以我们现在就知道为毛要封装成DelegatingTransactionAttribute了，因为可以保存事务的名字——就用方法的名字com.yfs.service.UserService.insert来作为当前事务的名字. 这真是一个好办法——不添加属性，而是添加回调来保存一个新的属性.</p>
<p>最后第12行Activate transaction synchronization for the current thread. Called by a transaction manager on transaction begin.</p>
<p>其实prepareSynchronization的作用就是Initialize transaction synchronization as appropriate.</p>
<p>最后源码33的40行返回了DefaultTransactionStatus status.</p>
<p>回到了源码32的27行.</p>
<p>prepareTransactionInfo,顾名思义就是准备TransactionInfo——通过txAttr和status</p>
<p>我们来看看源码</p>
<p>org.springframework.transaction.interceptor.TransactionAspectSupport.prepareTransactionInfo(PlatformTransactionManager, TransactionAttribute, String, TransactionStatus) 注意这是TransactionAspectSupport的方法，而TransactionAspectSupport是TransactionInterceptor的父类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">prepareTransactionInfo</span><span class="params">(PlatformTransactionManager tm,</span></span></span><br><span class="line"><span class="function"><span class="params">			TransactionAttribute txAttr, String joinpointIdentification, TransactionStatus status)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		TransactionInfo txInfo = <span class="keyword">new</span> TransactionInfo(tm, txAttr, joinpointIdentification);</span><br><span class="line">		<span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// We need a transaction for this method...</span></span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Getting transaction for ["</span> + txInfo.getJoinpointIdentification() + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// The transaction manager will flag an error if an incompatible tx already exists.</span></span><br><span class="line">			txInfo.newTransactionStatus(status);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// The TransactionInfo.hasTransaction() method will return false. We created it only</span></span><br><span class="line">			<span class="comment">// to preserve the integrity of the ThreadLocal stack maintained in this class.</span></span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"No need to create transaction for ["</span> + joinpointIdentification +</span><br><span class="line">						<span class="string">"]: This method is not transactional."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// We always bind the TransactionInfo to the thread, even if we didn't create</span></span><br><span class="line">		<span class="comment">// a new transaction here. This guarantees that the TransactionInfo stack</span></span><br><span class="line">		<span class="comment">// will be managed correctly even if no transaction was created by this aspect.</span></span><br><span class="line">		txInfo.bindToThread();</span><br><span class="line">		<span class="keyword">return</span> txInfo;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码43</p>
<p>上面的源码首先构建了TransactionInfo txInfo，最后txInfo中塞进去了status（即txInfo由TransactionAttribute txAttr和TransactionStatus status联合构成），最后第25行是绑定当前事务信息txInfo进入当前线程, 所谓绑定就是往 TransactionAspectSupport 中的一个threadlocal变量transactionInfoHolder中塞txInfo(事务信息).</p>
<p>org.springframework.transaction.interceptor.TransactionAspectSupport.TransactionInfo.bindToThread()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindToThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="comment">// Expose current TransactionStatus, preserving any existing TransactionStatus</span></span><br><span class="line">			<span class="comment">// for restoration after this transaction is complete.</span></span><br><span class="line">			<span class="keyword">this</span>.oldTransactionInfo = transactionInfoHolder.get();</span><br><span class="line">			transactionInfoHolder.set(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>最后源码43返回事务信息（一个TransactionInfo）.</p>
<p>至此，我们已经分析完源码32了.  回到【4】中的源码17的第17行. 进入TransactionInterceptor的invoke方法中传入的回调. 即源码16的12行，而源码16 的第12行其本质就是让拦截器链继续执行下一个拦截器. 但是【4】中我们分析出来了——拦截器栈只有一个拦截器，就是transactioninterceptor.  所以回到org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()，注意  CglibMethodInvocation是ReflectiveMethodInvocation的子类，就不要觉得奇怪了.  因为拦截器栈的启动就是从CglibMethodInvocation.proceed方法开始的(【1】源码33).</p>
<p>而因为拦截器栈中只有一个拦截器，所以就直接执行目标方法去了</p>
<p>org.springframework.aop.framework.CglibAopProxy.CglibMethodInvocation.invokeJoinpoint()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="comment">//	We start with an index of -1 and increment early.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.currentInterceptorIndex == <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> invokeJoinpoint();</span><br><span class="line">		&#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码44</p>
<p>即源码44在第五行就执行目标方法并返回了.其中target就是com.yfs.service.UserService@1a760689（因为动态代理中的target就是被包装对象嘛）.arguments是[], 毕竟我们的insert方法没有传参(这里写的insert比较简单). 然后就一路来到了（因为动态代理没有java源文件，所以看不了源码）目标方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		userDao.insert();</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>因为使用的是spring-jdbcTemplate，所以最后来到了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> PreparedStatementCreator psc, <span class="keyword">final</span> PreparedStatementSetter pss)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">		logger.debug(<span class="string">"Executing prepared SQL update"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> execute(psc, <span class="keyword">new</span> PreparedStatementCallback&lt;Integer&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Integer <span class="title">doInPreparedStatement</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (pss != <span class="keyword">null</span>) &#123;</span><br><span class="line">						pss.setValues(ps);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">int</span> rows = ps.executeUpdate(); <span class="comment">// ps是com.mchange.v2.c3p0.impl.NewProxyPreparedStatement，即c3p0数据源的preparedstatement，而其实跟进去，里面的inner是com.mysql.jdbc.JDBC42PreparedStatemen. 即数据源c3p0指挥真正干活的是mysql的东西</span></span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"SQL update affected "</span> + rows + <span class="string">" rows"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> rows;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (pss <span class="keyword">instanceof</span> ParameterDisposer) &#123;</span><br><span class="line">						((ParameterDisposer) pss).cleanupParameters();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                    源码49</p>
<p>再跟进execute方法                                </p>
<p>org.springframework.jdbc.core.JdbcTemplate.execute(PreparedStatementCreator, PreparedStatementCallback<t>)</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">            	Connection con = DataSourceUtils.getConnection(getDataSource());</span><br><span class="line">		PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">        Connection conToUse = con;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.nativeJdbcExtractor != <span class="keyword">null</span> &amp;&amp; <span class="comment">// 如果有自定义jdbc提取器</span></span><br><span class="line">					<span class="keyword">this</span>.nativeJdbcExtractor.isNativeConnectionNecessaryForNativePreparedStatements()) &#123;</span><br><span class="line">				conToUse = <span class="keyword">this</span>.nativeJdbcExtractor.getNativeConnection(con);</span><br><span class="line">			&#125;</span><br><span class="line">			ps = psc.createPreparedStatement(conToUse);</span><br><span class="line">			applyStatementSettings(ps);</span><br><span class="line">			PreparedStatement psToUse = ps;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.nativeJdbcExtractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">				psToUse = <span class="keyword">this</span>.nativeJdbcExtractor.getNativePreparedStatement(ps);</span><br><span class="line">			&#125;</span><br><span class="line">			T result = action.doInPreparedStatement(psToUse);</span><br><span class="line">			handleWarnings(ps);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">			<span class="comment">// Release Connection early, to avoid potential connection pool deadlock</span></span><br><span class="line">			<span class="comment">// in the case when the exception translator hasn't been initialized yet.</span></span><br><span class="line">			<span class="keyword">if</span> (psc <span class="keyword">instanceof</span> ParameterDisposer) &#123;</span><br><span class="line">				((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">			&#125;</span><br><span class="line">			String sql = getSql(psc);</span><br><span class="line">			psc = <span class="keyword">null</span>;</span><br><span class="line">			JdbcUtils.closeStatement(ps);</span><br><span class="line">			ps = <span class="keyword">null</span>;</span><br><span class="line">			DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">			con = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">throw</span> getExceptionTranslator().translate(<span class="string">"PreparedStatementCallback"</span>, sql, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (psc <span class="keyword">instanceof</span> ParameterDisposer) &#123;</span><br><span class="line">				((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">			&#125;</span><br><span class="line">			JdbcUtils.closeStatement(ps);</span><br><span class="line">			DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                    源码45</p>
<p>其中第五行我们考察一下，不消说，getDataSource()得到的肯定是c3p0数据源, </p>
<p>跟两步来到</p>
<p>org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSource)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Actually obtain a JDBC Connection from the given DataSource.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">doGetConnection</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">		Assert.notNull(dataSource, <span class="string">"No DataSource specified"</span>);</span><br><span class="line"></span><br><span class="line">		ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">return</span> conHolder.getConnection();</span><br></pre></td></tr></table></figure>
<p>​                                                                                            源码46</p>
<p>而TransactionSynchronizationManager的getResource方法(这是核心代码)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getResource</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br><span class="line">		Object value = doGetResource(actualKey);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Retrieved value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] bound to thread ["</span> +</span><br><span class="line">					Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Actually check the value of the resource that is bound for the given key.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">doGetResource</span><span class="params">(Object actualKey)</span> </span>&#123;</span><br><span class="line">		Map&lt;Object, Object&gt; map = resources.get();</span><br><span class="line">		<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Object value = map.get(actualKey);</span><br><span class="line">		<span class="comment">// Transparently remove ResourceHolder that was marked as void...</span></span><br><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</span><br><span class="line">			map.remove(actualKey);</span><br><span class="line">			<span class="comment">// Remove entire ThreadLocal if empty...</span></span><br><span class="line">			<span class="keyword">if</span> (map.isEmpty()) &#123;</span><br><span class="line">				resources.remove();</span><br><span class="line">			&#125;</span><br><span class="line">			value = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                        源码47</p>
<p>之前源码34的第五行就这样获取过资源（前面说了: 所谓资源就是当前线程绑定的map中根据数据源为key获取的txObject中的connectionHolder）,但是那是第一次，所以获取到的是null. doBegin（源码37）执行完之后，当前线程中就有了. 得到了当前线程根据数据源绑定的connectionHolder,里面有数据库连接. 最后源码46 的第九行返回了数据库连接.</p>
<p>回到源码45，第六行，则余下的代码就很顺眼了——创建PreparedStatement，然后执行 PreparedStatement.  最后将执行的结果result返回. 但是源码45有一行代码值得关注，就是第13行. 我们跟进去看看</p>
<p>org.springframework.jdbc.core.JdbcTemplate.applyStatementSettings(Statement)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Prepare the given JDBC Statement (or PreparedStatement or CallableStatement), applying statement settings such as fetch size, max rows, and query timeout.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyStatementSettings</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> fetchSize = getFetchSize();</span><br><span class="line">		<span class="keyword">if</span> (fetchSize != -<span class="number">1</span>) &#123;</span><br><span class="line">			stmt.setFetchSize(fetchSize);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> maxRows = getMaxRows();</span><br><span class="line">		<span class="keyword">if</span> (maxRows != -<span class="number">1</span>) &#123;</span><br><span class="line">			stmt.setMaxRows(maxRows);</span><br><span class="line">		&#125;</span><br><span class="line">		DataSourceUtils.applyTimeout(stmt, getDataSource(), getQueryTimeout());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码48</p>
<p>而getFetchSize() 这个方法Return the fetch size specified for this JdbcTemplate（默认是-1，<strong><em>Passing ‘-1’ will retrieve all the rows. This is default behavior.也就是默认是一次性把结果集的数据全部取出来,这样就容易造成内存不足</em></strong> ）.</p>
<p>第6行说，如果不是默认的-1，就根据JdbcTemplate配置的fetchSize参数对stmt进行设置. 同样处理maxRows参数. 最后处理timeout.  处理timeout的源码如下</p>
<p>DataSourceUtils的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applyTimeout</span><span class="params">(Statement stmt, DataSource dataSource, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">		Assert.notNull(stmt, <span class="string">"No Statement specified"</span>);</span><br><span class="line">		ConnectionHolder holder = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (dataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">			holder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; holder.hasTimeout()) &#123;</span><br><span class="line">			<span class="comment">// Remaining transaction timeout overrides specified value.</span></span><br><span class="line">			stmt.setQueryTimeout(holder.getTimeToLiveInSeconds());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (timeout &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// No current transaction timeout -&gt; apply specified value.</span></span><br><span class="line">			stmt.setQueryTimeout(timeout);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>其实也就是把当前线程中的connectionHolder中的deadline属性（holder.getTimeToLiveInSeconds源码就是这样写的）赋值给statement.  回到源码45的18行，就会执行源码49第六行中传入的回调. 直至源码49第13行执行PreparedStatement. 然后返回结果后进入源码45的36行的finally块进行处理. 包括源码45的40行的关闭PreparedStatement和释放连接回数据源（就是一个连接池）. 最后执行完目标方法之后，因为发现了 1/0 的算术异常，于是回到源码17的第21行，就要回滚事务. 即completeTransactionAfterThrowing方法.</p>
<p>跟进去</p>
<p>org.springframework.transaction.interceptor.TransactionAspectSupport.completeTransactionAfterThrowing(TransactionInfo, Throwable)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">completeTransactionAfterThrowing</span><span class="params">(TransactionInfo txInfo, Throwable ex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (txInfo != <span class="keyword">null</span> &amp;&amp; txInfo.hasTransaction()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Completing transaction for ["</span> + txInfo.getJoinpointIdentification() +</span><br><span class="line">						<span class="string">"] after exception: "</span> + ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (txInfo.transactionAttribute.rollbackOn(ex)) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by rollback exception"</span>, ex);</span><br><span class="line">					ex2.initApplicationException(ex);</span><br><span class="line">					<span class="keyword">throw</span> ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (RuntimeException ex2) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by rollback exception"</span>, ex);</span><br><span class="line">					<span class="keyword">throw</span> ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by rollback error"</span>, ex);</span><br><span class="line">					<span class="keyword">throw</span> err;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// We don't roll back on this exception.</span></span><br><span class="line">				<span class="comment">// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by commit exception"</span>, ex);</span><br><span class="line">					ex2.initApplicationException(ex);</span><br><span class="line">					<span class="keyword">throw</span> ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (RuntimeException ex2) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by commit exception"</span>, ex);</span><br><span class="line">					<span class="keyword">throw</span> ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">					logger.error(<span class="string">"Application exception overridden by commit error"</span>, ex);</span><br><span class="line">					<span class="keyword">throw</span> err;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码50</p>
<p>源码50第二行的hasTransaction就是判断txInfo的transactionStatus是不是非空.  源码50第七行的就是判断Should we roll back on the given exception?  最后发现判断的依据是（当然，有一些细节，这里就不具体跟了，就是源码50第七行的rollbackOn方法的细节就不跟了）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ex <span class="keyword">instanceof</span> RuntimeException || ex <span class="keyword">instanceof</span> Error</span><br></pre></td></tr></table></figure>
<p>也就是Spring 事务一般而言，只有运行时异常和错误才会回滚, 其他类型不会回滚(即如果不满足问滚条件即使抛出异常’也同样会提交 ，例如你抛出的是Exception). 虽然不细跟了，但是有一点还是必须要说的, 那就是我们其实可以使用@Transactional注解的rollbackFor属性扩展让遇到我们自定义的异常的时候也可以回滚. 为什么呢?  答案在</p>
<p>源码50的第七行代码的rollbackOn（看来还是要跟一下,囧）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rollbackOn</span><span class="params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Applying rules to determine whether transaction should rollback on "</span> + ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		RollbackRuleAttribute winner = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">int</span> deepest = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.rollbackRules != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (RollbackRuleAttribute rule : <span class="keyword">this</span>.rollbackRules) &#123;</span><br><span class="line">				<span class="keyword">int</span> depth = rule.getDepth(ex);</span><br><span class="line">				<span class="keyword">if</span> (depth &gt;= <span class="number">0</span> &amp;&amp; depth &lt; deepest) &#123;</span><br><span class="line">					deepest = depth;</span><br><span class="line">					winner = rule;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">       ...</span><br></pre></td></tr></table></figure>
<p>这里的rollbackRules就是从@Transactional注解的rollbackFor属性提取出来的.  何以为证呢?  rollbackRules属性是RuleBasedTransactionAttribute的属性，而RuleBasedTransactionAttribute的初始化是在org.springframework.transaction.annotation.SpringTransactionAnnotationParser.parseTransactionAnnotation(AnnotationAttributes)中完成的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> TransactionAttribute <span class="title">parseTransactionAnnotation</span><span class="params">(AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">		RuleBasedTransactionAttribute rbta = <span class="keyword">new</span> RuleBasedTransactionAttribute();</span><br><span class="line"></span><br><span class="line">		Propagation propagation = attributes.getEnum(<span class="string">"propagation"</span>);</span><br><span class="line">		rbta.setPropagationBehavior(propagation.value());</span><br><span class="line">		Isolation isolation = attributes.getEnum(<span class="string">"isolation"</span>);</span><br><span class="line">		rbta.setIsolationLevel(isolation.value());</span><br><span class="line">		rbta.setTimeout(attributes.getNumber(<span class="string">"timeout"</span>).intValue());</span><br><span class="line">		rbta.setReadOnly(attributes.getBoolean(<span class="string">"readOnly"</span>));</span><br><span class="line">		rbta.setQualifier(attributes.getString(<span class="string">"value"</span>));</span><br><span class="line"></span><br><span class="line">		List&lt;RollbackRuleAttribute&gt; rollbackRules = <span class="keyword">new</span> ArrayList&lt;RollbackRuleAttribute&gt;();</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; rbRule : attributes.getClassArray(<span class="string">"rollbackFor"</span>)) &#123;</span><br><span class="line">			rollbackRules.add(<span class="keyword">new</span> RollbackRuleAttribute(rbRule));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (String rbRule : attributes.getStringArray(<span class="string">"rollbackForClassName"</span>)) &#123;</span><br><span class="line">			rollbackRules.add(<span class="keyword">new</span> RollbackRuleAttribute(rbRule));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; rbRule : attributes.getClassArray(<span class="string">"noRollbackFor"</span>)) &#123;</span><br><span class="line">			rollbackRules.add(<span class="keyword">new</span> NoRollbackRuleAttribute(rbRule));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (String rbRule : attributes.getStringArray(<span class="string">"noRollbackForClassName"</span>)) &#123;</span><br><span class="line">			rollbackRules.add(<span class="keyword">new</span> NoRollbackRuleAttribute(rbRule));</span><br><span class="line">		&#125;</span><br><span class="line">		rbta.setRollbackRules(rollbackRules);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> rbta;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>而SpringTransactionAnnotationParser就是加在AnnotationTransactionAttributeSource，即【4】的源码11的第二个bean. 也就是在这个bean对@Transactional注解进行解析的时候就会构建txAttr。</p>
<p>然后来到源码50的第9行，进行回滚, 就是用事务管理器DataSourceTransactionManager利用当前的TransactionStatus进行回滚,  我们来看看源码</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.rollback(TransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (status.isCompleted()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">					<span class="string">"Transaction is already completed - do not call commit or rollback more than once per transaction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;</span><br><span class="line">		processRollback(defStatus);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                    源码51</p>
<p>显然，对于已经完成的事务是不能回滚的.</p>
<p>然后来到源码51 的第九行，最后跟进</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.processRollback(DefaultTransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process an actual rollback.</span></span><br><span class="line"><span class="comment">	 * The completed flag has already been checked.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> status object representing the transaction</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> TransactionException in case of rollback failure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processRollback</span><span class="params">(DefaultTransactionStatus status)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				triggerBeforeCompletion(status);</span><br><span class="line">				<span class="keyword">if</span> (status.hasSavepoint()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Rolling back transaction to savepoint"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					status.rollbackToHeldSavepoint(); <span class="comment">//如果有保存点，也就是当前事务为单独的线程则会退到保存点</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (status.isNewTransaction()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Initiating transaction rollback"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					doRollback(status); <span class="comment">//如果 当前事务为独立的新事务 ，则直接 回退</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (status.hasTransaction()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123;</span><br><span class="line">						<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">							logger.debug(<span class="string">"Participating transaction failed - marking existing transaction as rollback-only"</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						doSetRollbackOnly(status); <span class="comment">// 如果当前事务不是独立的事务，那么只能标记状态 ， 等到事务链执行完毕后统一回滚</span></span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">							logger.debug(<span class="string">"Participating transaction failed - letting transaction originator decide on rollback"</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					logger.debug(<span class="string">"Should roll back transaction but cannot - no transaction available"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">				triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">				triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">				<span class="keyword">throw</span> err;</span><br><span class="line">			&#125;</span><br><span class="line">			triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			cleanupAfterCompletion(status);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                            源码52</p>
<p>源码52的注释写的也很清楚了——真正的回滚.</p>
<p>然后判断有没有回滚点. 我这里是没有的，但是符合第17条判断，所以进入到源码52的第21行.</p>
<p>跟进</p>
<p>org.springframework.jdbc.datasource.DataSourceTransactionManager.doRollback(DefaultTransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRollback</span><span class="params">(DefaultTransactionStatus status)</span> </span>&#123;</span><br><span class="line">		DataSourceTransactionObject txObject = (DataSourceTransactionObject) status.getTransaction();</span><br><span class="line">		Connection con = txObject.getConnectionHolder().getConnection();</span><br><span class="line">		<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Rolling back JDBC transaction on Connection ["</span> + con + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			con.rollback();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(<span class="string">"Could not roll back JDBC transaction"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                源码53</p>
<p>从源码33的第37行知道TransactionStatus中有transaction（即一个txObject，看源码33的37行）. 最后拿出txObject中的数据库连接——就是当前线程绑定的数据库连接，执行rollback——这才是Spring层面最底层的——通过com.mchange.v2.c3p0.impl.NewProxyConnection和数据库打交道.</p>
<p>这样就实现了回滚事务.</p>
<p>下面来看看如何提交事务. 也就是如果</p>
<p>将示例代码中的 int i = 1/0 删掉. 让事务正常提交的话.</p>
<p>则执行的就是源码17 的第27行. 跟进</p>
<p>org.springframework.transaction.interceptor.TransactionAspectSupport.commitTransactionAfterReturning(TransactionInfo)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">commitTransactionAfterReturning</span><span class="params">(TransactionInfo txInfo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (txInfo != <span class="keyword">null</span> &amp;&amp; txInfo.hasTransaction()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Completing transaction for ["</span> + txInfo.getJoinpointIdentification() + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                        源码54</p>
<p>和回滚其实很类似，我们跟进第6行.——用事务管理器提交事务(根据TransactionStatus)</p>
<p>跟进</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.commit(TransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (status.isCompleted()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">					<span class="string">"Transaction is already completed - do not call commit or rollback more than once per transaction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		processCommit(defStatus);</span><br></pre></td></tr></table></figure>
<p>​                                                                源码55</p>
<p>事务如果已经完成的话，则抛异常. 否则的话，执行第八行. 跟进</p>
<p>org.springframework.transaction.support.AbstractPlatformTransactionManager.processCommit(DefaultTransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process an actual commit.</span></span><br><span class="line"><span class="comment">	 * Rollback-only flags have already been checked and applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> status object representing the transaction</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> TransactionException in case of commit failure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCommit</span><span class="params">(DefaultTransactionStatus status)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">boolean</span> beforeCompletionInvoked = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				prepareForCommit(status);</span><br><span class="line">				triggerBeforeCommit(status);</span><br><span class="line">				triggerBeforeCompletion(status);</span><br><span class="line">				beforeCompletionInvoked = <span class="keyword">true</span>;</span><br><span class="line">				<span class="keyword">boolean</span> globalRollbackOnly = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">if</span> (status.isNewTransaction() || isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">					globalRollbackOnly = status.isGlobalRollbackOnly();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (status.hasSavepoint()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Releasing transaction savepoint"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					status.releaseHeldSavepoint();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (status.isNewTransaction()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Initiating transaction commit"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					doCommit(status);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Throw UnexpectedRollbackException if we have a global rollback-only</span></span><br><span class="line">				<span class="comment">// marker but still didn't get a corresponding exception from commit.</span></span><br><span class="line">				<span class="keyword">if</span> (globalRollbackOnly) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedRollbackException(</span><br><span class="line">							<span class="string">"Transaction silently rolled back because it has been marked as rollback-only"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">            ...</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">			cleanupAfterCompletion(status);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                        源码56</p>
<p>因为这是独立的事务则直接提交 ，即直接进入源码56的29行. 跟进</p>
<p>org.springframework.jdbc.datasource.DataSourceTransactionManager.doCommit(DefaultTransactionStatus)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">(DefaultTransactionStatus status)</span> </span>&#123;</span><br><span class="line">		DataSourceTransactionObject txObject = (DataSourceTransactionObject) status.getTransaction();</span><br><span class="line">		Connection con = txObject.getConnectionHolder().getConnection();</span><br><span class="line">		<span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Committing JDBC transaction on Connection ["</span> + con + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			con.commit();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(<span class="string">"Could not commit JDBC transaction"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                                            源码57</p>
<p>这个和之前讲回滚的时候很像. 都是拿txObject（源码33的第37行）.然后获取数据库连接（com.mchange.v2.c3p0.impl.NewProxyConnection），最后用它提交事务. 最后clean事务信息，表现为清空TransactionSynchronizationManager中的一系列的ThreadLocal变量(即源码56 的第40行)，解除各种线程绑定、重设连接的属性之后归还数据库连接回连接池.</p>
<p>至此，提交事务的流程也分析完了.</p>
<p>先写到这里吧~ 还有一篇要写事务的嵌套以及如何将包装好的代理放进AopContext. 后面再写. </p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>【1】<a href="https://yfsyfs.github.io/2019/06/13/spring-AOP-注解原理/" target="_blank" rel="noopener">https://yfsyfs.github.io/2019/06/13/spring-AOP-%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86/</a></p>
<p>【2】<a href="https://github.com/yfsyfs/backend/tree/master/spring-annotation-transaction" target="_blank" rel="noopener">https://github.com/yfsyfs/backend/tree/master/spring-annotation-transaction</a></p>
<p>【3】Spring 源码深度解析 第二版 第十章</p>
<p>【4】<a href="https://yfsyfs.github.io/2019/06/17/Spring-事务源码解析/" target="_blank" rel="noopener">https://yfsyfs.github.io/2019/06/17/Spring-%E4%BA%8B%E5%8A%A1%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a></p>
<p>【5】<a href="https://blog.csdn.net/firefoxboy/article/details/3023687" target="_blank" rel="noopener">https://blog.csdn.net/firefoxboy/article/details/3023687</a></p>

          <div id="vcomments"></div>
          <script>
            new Valine({
              el: '#vcomments' ,
              appId: 'XlY58twgvIOmA3HxDHid3qxr-gzGzoHsz',
              appKey: 'XPVIq9oMfocEh6gcBmLadxCb',
              notify:false,
              verify:false,
              avatar:'mp',
              placeholder: '请奉上您的真知灼见, 谢谢!'
            });
          </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/18/Spring-事务源码解析（后篇）/" data-id="ck11savza02jn1ovm3pwm441d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/事务/">事务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端/">后端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码/">源码</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/06/19/为什么要读源码-暨-我后面的个人提升计划/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          为什么要读源码 暨 我后面的个人提升计划
        
      </div>
    </a>
  
  
    <a href="/2019/06/17/结合源码分析-Spring-bean的生命周期/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">结合源码分析 Spring bean的生命周期</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/01背包/">01背包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/51nod/">51nod</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/A-算法/">A*算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BST/">BST</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-Primer/">C++ Primer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CRT/">CRT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C和指针/">C和指针</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DAG/">DAG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DFS/">DFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DLX/">DLX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DP/">DP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dirac定理/">Dirac定理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EK/">EK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFT/">FFT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ford-Fulkerson/">Ford-Fulkerson</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HotSpot/">HotSpot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Huffman树/">Huffman树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDA/">IDA*</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/">JDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JMM/">JMM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JRE/">JRE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Johnson不等式/">Johnson不等式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KMP/">KMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LCA/">LCA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LCS/">LCS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LDAP/">LDAP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LIS/">LIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MST/">MST</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Manacher算法/">Manacher算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Miller-Rabin/">Miller-Rabin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oauth2-0/">Oauth2.0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenJudge/">OpenJudge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pollard-rho/">Pollard rho</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RMQ/">RMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ST/">ST</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVN/">SVN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tarjan/">Tarjan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activemq/">activemq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ball树/">ball树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bcc/">bcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bfs/">bfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bfs搜索带权图可行未必最短路径/">bfs搜索带权图可行未必最短路径</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-c/">c/c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cf/">cf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dfs/">dfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dfs找一条路径找到就不玩了则不需要改回来/">dfs找一条路径找到就不玩了则不需要改回来</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dijkstra/">dijkstra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dp/">dp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fft/">fft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fleury/">fleury</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/floyd/">floyd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fzu/">fzu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gabow/">gabow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcd/">gcd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcj/">gcj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdfs/">hdfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdu/">hdu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hibernate/">hibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hihocoder/">hihocoder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hustoj/">hustoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发编程实践/">java并发编程实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdbc/">jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jpa/">jpa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/karatsuba/">karatsuba</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kasaraju/">kasaraju</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kd树/">kd树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kmp/">kmp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/knn/">knn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kruskal/">kruskal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kth/">kth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libreoj/">libreoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lightoj/">lightoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mapreduce/">mapreduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/miller-rabin/">miller-rabin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/next-permutation/">next_permutation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nth-element/">nth_element</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oj/">oj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/">oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pair的用法/">pair的用法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/poj/">poj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pollard-rho/">pollard-rho</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/">postgresql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prim/">prim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sbt/">sbt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scc/">scc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sdutoj/">sdutoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servlet/">servlet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sjtuoj/">sjtuoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spfa/">spfa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spoj/">spoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springmvc/">springmvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sscanf/">sscanf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sstream/">sstream</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stringstream/">stringstream</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swagger/">swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/synchronized/">synchronized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tarjan/">tarjan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/topK/">topK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/treap/">treap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/trie/">trie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tsp/">tsp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uva/">uva</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vector初始化容量/">vector初始化容量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/volatile/">volatile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zoj/">zoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zzuli/">zzuli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zzulioj/">zzulioj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/三分/">三分</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中位数/">中位数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中国剩余定理/">中国剩余定理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事务/">事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二分/">二分</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二分图/">二分图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二分查找/">二分查找</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二分答案/">二分答案</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二叉树/">二叉树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二进制状态压缩/">二进制状态压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交叉染色/">交叉染色</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交叉染色法/">交叉染色法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优先队列/">优先队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/传递闭包/">传递闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/位图/">位图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全排列/">全排列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存模型/">内存模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内部排序/">内部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分块矩阵快速幂/">分块矩阵快速幂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分支限界/">分支限界</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分治/">分治</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分解素因数/">分解素因数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/划分数/">划分数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/剑指offer/">剑指offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/剪枝/">剪枝</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/割点/">割点</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/割边/">割边</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态查找/">动态查找</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态规划/">动态规划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区间DP/">区间DP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单向连通/">单向连通</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单调子序列/">单调子序列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单调队列/">单调队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/卡米切尔数/">卡米切尔数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/原生js/">原生js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/双向bfs/">双向bfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/反向建图/">反向建图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/反转开关问题/">反转开关问题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/同步/">同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后台/">后台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端/">后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端，数据库-mysql/">后端，数据库, mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后缀树/">后缀树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/启发式搜索/">启发式搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/哈密顿回路/">哈密顿回路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/哈希/">哈希</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/回归/">回归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/回文/">回文</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/回溯/">回溯</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图/">图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/在线算法/">在线算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/坐标离散化/">坐标离散化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/块/">块</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/堆/">堆</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/堆优化/">堆优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/堆排/">堆排</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/堆排序/">堆排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/外部排序/">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多源多汇/">多源多汇</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多重背包/">多重背包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多重集组合数/">多重集组合数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字典序最小/">字典序最小</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字符串/">字符串</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字符串匹配/">字符串匹配</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/完全背包/">完全背包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/宽搜/">宽搜</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小程序/">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/尺取法/">尺取法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/左式堆/">左式堆</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/带括号带逗号的恶心输入/">带括号带逗号的恶心输入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/带权并查集/">带权并查集</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/平方分割/">平方分割</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/平衡查找树/">平衡查找树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/平面最近点对/">平面最近点对</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并查集/">并查集</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/康托展开/">康托展开</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/弹性碰撞/">弹性碰撞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/强连通/">强连通</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/强连通分支/">强连通分支</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/归并排序/">归并排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/归并树/">归并树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心语/">心语</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快排/">快排</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快速幂/">快速幂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感悟/">感悟</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/手工扩栈/">手工扩栈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/扩展KMP/">扩展KMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/扩展欧几里得/">扩展欧几里得</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/抓包/">抓包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/折半枚举/">折半枚举</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/拓扑排序/">拓扑排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序/">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/搜索/">搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作系统/">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/教材/">教材</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数学/">数学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数组/">数组</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数论/">数论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/方差优化/">方差优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/暴力/">暴力</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最大公约数/">最大公约数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最大流/">最大流</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最大流算法的优化/">最大流算法的优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最大流算法重弧和自环不会影响算法的正确性而只会影响效率/">最大流算法重弧和自环不会影响算法的正确性而只会影响效率</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最大生成树/">最大生成树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最小正整数解/">最小正整数解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最小生成树/">最小生成树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最短路/">最短路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最短路径/">最短路径</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/最长回文子串/">最长回文子串</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/有向图/">有向图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习/">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂/">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/板子/">板子</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查找/">查找</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查找树/">查找树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/栈/">栈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树/">树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树堆/">树堆</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树形dp/">树形dp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树排/">树排</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树状数组/">树状数组</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树的直径/">树的直径</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/桶排序/">桶排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模块化/">模块化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模拟/">模拟</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模拟退火/">模拟退火</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模板/">模板</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/次短路/">次短路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/欧几里得/">欧几里得</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/欧拉函数/">欧拉函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/欧拉回路/">欧拉回路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/欧拉环游/">欧拉环游</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/欧拉环路/">欧拉环路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/死锁/">死锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/泛洪/">泛洪</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/洛谷/">洛谷</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/洪特规则/">洪特规则</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/浮点数二分答案/">浮点数二分答案</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/深搜/">深搜</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码/">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码分析/">源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/滚动数组/">滚动数组</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/版本控制/">版本控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/牛客网/">牛客网</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/牛顿迭代法/">牛顿迭代法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/状态压缩/">状态压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/状态压缩DP/">状态压缩DP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生成树/">生成树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/百练/">百练</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/矩阵快速幂/">矩阵快速幂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/离散化/">离散化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/空间复杂度优化/">空间复杂度优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/筛法/">筛法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/简历/">简历</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/精确匹配/">精确匹配</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/精确覆盖/">精确覆盖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/素数/">素数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/素数测试/">素数测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/约瑟夫环/">约瑟夫环</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线上问题/">线上问题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线性同余方程/">线性同余方程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线性筛/">线性筛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线段树/">线段树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编译原理/">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缩点/">缩点</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缩点重构DAG/">缩点重构DAG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络协议/">网络协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络流/">网络流</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络流建图/">网络流建图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/背包/">背包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/胜者树/">胜者树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自己动手用java写编译器/">自己动手用java写编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/菜鸟教材/">菜鸟教材</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/蓝桥杯/">蓝桥杯</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算几何/">计算几何</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/记忆化搜索/">记忆化搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/词典/">词典</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负权环/">负权环</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/败者树/">败者树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/贪心/">贪心</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/轮播图/">轮播图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/边bcc/">边bcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/连通/">连通</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/连通分支/">连通分支</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/连通性/">连通性</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/逆元/">逆元</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/逆序数/">逆序数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/递归/">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/递归转栈/">递归转栈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/遍历/">遍历</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/邻接多重表/">邻接多重表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/邻接链表法/">邻接链表法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/重复覆盖/">重复覆盖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/链表/">链表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/锁/">锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/队列/">队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集合/">集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态查找树/">静态查找树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/非递归/">非递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马踏棋盘/">马踏棋盘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高精度/">高精度</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/01背包/" style="font-size: 12.26px;">01背包</a> <a href="/tags/51nod/" style="font-size: 10px;">51nod</a> <a href="/tags/A-算法/" style="font-size: 10px;">A*算法</a> <a href="/tags/BST/" style="font-size: 10px;">BST</a> <a href="/tags/C/" style="font-size: 17.42px;">C</a> <a href="/tags/C/" style="font-size: 10.97px;">C++</a> <a href="/tags/C-Primer/" style="font-size: 10px;">C++ Primer</a> <a href="/tags/CRT/" style="font-size: 10px;">CRT</a> <a href="/tags/C和指针/" style="font-size: 17.1px;">C和指针</a> <a href="/tags/DAG/" style="font-size: 11.29px;">DAG</a> <a href="/tags/DFS/" style="font-size: 10.32px;">DFS</a> <a href="/tags/DLX/" style="font-size: 11.61px;">DLX</a> <a href="/tags/DP/" style="font-size: 16.45px;">DP</a> <a href="/tags/Dirac定理/" style="font-size: 10px;">Dirac定理</a> <a href="/tags/EK/" style="font-size: 11.61px;">EK</a> <a href="/tags/FFT/" style="font-size: 10px;">FFT</a> <a href="/tags/Ford-Fulkerson/" style="font-size: 10px;">Ford-Fulkerson</a> <a href="/tags/HotSpot/" style="font-size: 10px;">HotSpot</a> <a href="/tags/Huffman树/" style="font-size: 10px;">Huffman树</a> <a href="/tags/IDA/" style="font-size: 10.65px;">IDA*</a> <a href="/tags/JDK/" style="font-size: 16.13px;">JDK</a> <a href="/tags/JMM/" style="font-size: 10.32px;">JMM</a> <a href="/tags/JRE/" style="font-size: 10px;">JRE</a> <a href="/tags/JVM/" style="font-size: 10.65px;">JVM</a> <a href="/tags/Johnson不等式/" style="font-size: 10px;">Johnson不等式</a> <a href="/tags/KMP/" style="font-size: 10px;">KMP</a> <a href="/tags/LCA/" style="font-size: 10.65px;">LCA</a> <a href="/tags/LCS/" style="font-size: 10.32px;">LCS</a> <a href="/tags/LDAP/" style="font-size: 10.32px;">LDAP</a> <a href="/tags/LIS/" style="font-size: 10.97px;">LIS</a> <a href="/tags/MST/" style="font-size: 10.65px;">MST</a> <a href="/tags/Manacher算法/" style="font-size: 10px;">Manacher算法</a> <a href="/tags/Miller-Rabin/" style="font-size: 10.65px;">Miller-Rabin</a> <a href="/tags/Oauth2-0/" style="font-size: 10px;">Oauth2.0</a> <a href="/tags/OpenJudge/" style="font-size: 10px;">OpenJudge</a> <a href="/tags/Pollard-rho/" style="font-size: 10.32px;">Pollard rho</a> <a href="/tags/RMQ/" style="font-size: 11.61px;">RMQ</a> <a href="/tags/ST/" style="font-size: 10px;">ST</a> <a href="/tags/SVN/" style="font-size: 10px;">SVN</a> <a href="/tags/Spring/" style="font-size: 13.87px;">Spring</a> <a href="/tags/String/" style="font-size: 10.32px;">String</a> <a href="/tags/Tarjan/" style="font-size: 10px;">Tarjan</a> <a href="/tags/activemq/" style="font-size: 10px;">activemq</a> <a href="/tags/ai/" style="font-size: 10.32px;">ai</a> <a href="/tags/ball树/" style="font-size: 10px;">ball树</a> <a href="/tags/bcc/" style="font-size: 10px;">bcc</a> <a href="/tags/bfs/" style="font-size: 12.9px;">bfs</a> <a href="/tags/bfs搜索带权图可行未必最短路径/" style="font-size: 10px;">bfs搜索带权图可行未必最短路径</a> <a href="/tags/c-c/" style="font-size: 10px;">c/c++</a> <a href="/tags/cf/" style="font-size: 10px;">cf</a> <a href="/tags/dfs/" style="font-size: 14.84px;">dfs</a> <a href="/tags/dfs找一条路径找到就不玩了则不需要改回来/" style="font-size: 10px;">dfs找一条路径找到就不玩了则不需要改回来</a> <a href="/tags/dijkstra/" style="font-size: 11.29px;">dijkstra</a> <a href="/tags/dp/" style="font-size: 14.52px;">dp</a> <a href="/tags/fft/" style="font-size: 10px;">fft</a> <a href="/tags/fleury/" style="font-size: 11.61px;">fleury</a> <a href="/tags/floyd/" style="font-size: 10.65px;">floyd</a> <a href="/tags/fzu/" style="font-size: 10.65px;">fzu</a> <a href="/tags/gabow/" style="font-size: 10px;">gabow</a> <a href="/tags/gcd/" style="font-size: 10.65px;">gcd</a> <a href="/tags/gcj/" style="font-size: 10px;">gcj</a> <a href="/tags/gradle/" style="font-size: 10.32px;">gradle</a> <a href="/tags/hadoop/" style="font-size: 10.32px;">hadoop</a> <a href="/tags/hdfs/" style="font-size: 10.32px;">hdfs</a> <a href="/tags/hdu/" style="font-size: 17.74px;">hdu</a> <a href="/tags/hibernate/" style="font-size: 10px;">hibernate</a> <a href="/tags/hihocoder/" style="font-size: 10.32px;">hihocoder</a> <a href="/tags/hustoj/" style="font-size: 10px;">hustoj</a> <a href="/tags/java并发编程实践/" style="font-size: 15.48px;">java并发编程实践</a> <a href="/tags/jdbc/" style="font-size: 10.32px;">jdbc</a> <a href="/tags/jpa/" style="font-size: 10px;">jpa</a> <a href="/tags/karatsuba/" style="font-size: 10px;">karatsuba</a> <a href="/tags/kasaraju/" style="font-size: 10px;">kasaraju</a> <a href="/tags/kd树/" style="font-size: 12.26px;">kd树</a> <a href="/tags/kmp/" style="font-size: 10px;">kmp</a> <a href="/tags/knn/" style="font-size: 10px;">knn</a> <a href="/tags/kruskal/" style="font-size: 10.32px;">kruskal</a> <a href="/tags/kth/" style="font-size: 10.32px;">kth</a> <a href="/tags/leetcode/" style="font-size: 12.9px;">leetcode</a> <a href="/tags/libreoj/" style="font-size: 10px;">libreoj</a> <a href="/tags/lightoj/" style="font-size: 11.94px;">lightoj</a> <a href="/tags/mapreduce/" style="font-size: 10px;">mapreduce</a> <a href="/tags/miller-rabin/" style="font-size: 10px;">miller-rabin</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/next-permutation/" style="font-size: 10px;">next_permutation</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/nth-element/" style="font-size: 10px;">nth_element</a> <a href="/tags/oj/" style="font-size: 19.68px;">oj</a> <a href="/tags/oracle/" style="font-size: 10px;">oracle</a> <a href="/tags/pair的用法/" style="font-size: 10px;">pair的用法</a> <a href="/tags/poj/" style="font-size: 19.35px;">poj</a> <a href="/tags/pollard-rho/" style="font-size: 10px;">pollard-rho</a> <a href="/tags/postgresql/" style="font-size: 10px;">postgresql</a> <a href="/tags/prim/" style="font-size: 10.97px;">prim</a> <a href="/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/tags/scc/" style="font-size: 10.97px;">scc</a> <a href="/tags/sdutoj/" style="font-size: 11.61px;">sdutoj</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/sjtuoj/" style="font-size: 10px;">sjtuoj</a> <a href="/tags/spfa/" style="font-size: 10.65px;">spfa</a> <a href="/tags/spoj/" style="font-size: 10px;">spoj</a> <a href="/tags/spring/" style="font-size: 11.94px;">spring</a> <a href="/tags/springboot/" style="font-size: 10.65px;">springboot</a> <a href="/tags/springmvc/" style="font-size: 10.32px;">springmvc</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/sscanf/" style="font-size: 10px;">sscanf</a> <a href="/tags/sstream/" style="font-size: 10px;">sstream</a> <a href="/tags/stringstream/" style="font-size: 10px;">stringstream</a> <a href="/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/tags/synchronized/" style="font-size: 10.32px;">synchronized</a> <a href="/tags/tarjan/" style="font-size: 11.29px;">tarjan</a> <a href="/tags/topK/" style="font-size: 10.32px;">topK</a> <a href="/tags/treap/" style="font-size: 10px;">treap</a> <a href="/tags/trie/" style="font-size: 11.94px;">trie</a> <a href="/tags/tsp/" style="font-size: 10px;">tsp</a> <a href="/tags/uva/" style="font-size: 11.94px;">uva</a> <a href="/tags/vector初始化容量/" style="font-size: 10px;">vector初始化容量</a> <a href="/tags/volatile/" style="font-size: 10.32px;">volatile</a> <a href="/tags/vue/" style="font-size: 10.65px;">vue</a> <a href="/tags/zoj/" style="font-size: 10.32px;">zoj</a> <a href="/tags/zzuli/" style="font-size: 10px;">zzuli</a> <a href="/tags/zzulioj/" style="font-size: 10px;">zzulioj</a> <a href="/tags/三分/" style="font-size: 10.32px;">三分</a> <a href="/tags/中位数/" style="font-size: 10px;">中位数</a> <a href="/tags/中国剩余定理/" style="font-size: 10px;">中国剩余定理</a> <a href="/tags/事务/" style="font-size: 11.29px;">事务</a> <a href="/tags/二分/" style="font-size: 10px;">二分</a> <a href="/tags/二分图/" style="font-size: 10px;">二分图</a> <a href="/tags/二分查找/" style="font-size: 10.32px;">二分查找</a> <a href="/tags/二分答案/" style="font-size: 11.94px;">二分答案</a> <a href="/tags/二叉树/" style="font-size: 10.32px;">二叉树</a> <a href="/tags/二进制状态压缩/" style="font-size: 10px;">二进制状态压缩</a> <a href="/tags/交叉染色/" style="font-size: 10px;">交叉染色</a> <a href="/tags/交叉染色法/" style="font-size: 10px;">交叉染色法</a> <a href="/tags/优先队列/" style="font-size: 14.19px;">优先队列</a> <a href="/tags/传递闭包/" style="font-size: 10px;">传递闭包</a> <a href="/tags/位图/" style="font-size: 10px;">位图</a> <a href="/tags/全排列/" style="font-size: 12.58px;">全排列</a> <a href="/tags/内存模型/" style="font-size: 10.32px;">内存模型</a> <a href="/tags/内部排序/" style="font-size: 10px;">内部排序</a> <a href="/tags/分块矩阵快速幂/" style="font-size: 10px;">分块矩阵快速幂</a> <a href="/tags/分支限界/" style="font-size: 10.97px;">分支限界</a> <a href="/tags/分治/" style="font-size: 10.65px;">分治</a> <a href="/tags/分解素因数/" style="font-size: 11.29px;">分解素因数</a> <a href="/tags/划分数/" style="font-size: 10.32px;">划分数</a> <a href="/tags/前端/" style="font-size: 11.29px;">前端</a> <a href="/tags/剑指offer/" style="font-size: 10px;">剑指offer</a> <a href="/tags/剪枝/" style="font-size: 10.65px;">剪枝</a> <a href="/tags/割点/" style="font-size: 11.29px;">割点</a> <a href="/tags/割边/" style="font-size: 10.97px;">割边</a> <a href="/tags/动态查找/" style="font-size: 10px;">动态查找</a> <a href="/tags/动态规划/" style="font-size: 11.61px;">动态规划</a> <a href="/tags/区间DP/" style="font-size: 10.32px;">区间DP</a> <a href="/tags/单向连通/" style="font-size: 10px;">单向连通</a> <a href="/tags/单调子序列/" style="font-size: 10.32px;">单调子序列</a> <a href="/tags/单调队列/" style="font-size: 10.32px;">单调队列</a> <a href="/tags/卡米切尔数/" style="font-size: 10px;">卡米切尔数</a> <a href="/tags/原生js/" style="font-size: 10px;">原生js</a> <a href="/tags/双向bfs/" style="font-size: 10px;">双向bfs</a> <a href="/tags/反向建图/" style="font-size: 10px;">反向建图</a> <a href="/tags/反转开关问题/" style="font-size: 10.32px;">反转开关问题</a> <a href="/tags/同步/" style="font-size: 10.32px;">同步</a> <a href="/tags/后台/" style="font-size: 10px;">后台</a> <a href="/tags/后端/" style="font-size: 18.71px;">后端</a> <a href="/tags/后端，数据库-mysql/" style="font-size: 10px;">后端，数据库, mysql</a> <a href="/tags/后缀树/" style="font-size: 10px;">后缀树</a> <a href="/tags/启发式搜索/" style="font-size: 10.32px;">启发式搜索</a> <a href="/tags/哈密顿回路/" style="font-size: 10px;">哈密顿回路</a> <a href="/tags/哈希/" style="font-size: 11.29px;">哈希</a> <a href="/tags/回归/" style="font-size: 10px;">回归</a> <a href="/tags/回文/" style="font-size: 10px;">回文</a> <a href="/tags/回溯/" style="font-size: 10px;">回溯</a> <a href="/tags/图/" style="font-size: 18.39px;">图</a> <a href="/tags/在线算法/" style="font-size: 10px;">在线算法</a> <a href="/tags/坐标离散化/" style="font-size: 10px;">坐标离散化</a> <a href="/tags/块/" style="font-size: 10px;">块</a> <a href="/tags/堆/" style="font-size: 10px;">堆</a> <a href="/tags/堆优化/" style="font-size: 10.65px;">堆优化</a> <a href="/tags/堆排/" style="font-size: 10.32px;">堆排</a> <a href="/tags/堆排序/" style="font-size: 10px;">堆排序</a> <a href="/tags/外部排序/" style="font-size: 10px;">外部排序</a> <a href="/tags/多源多汇/" style="font-size: 10px;">多源多汇</a> <a href="/tags/多重背包/" style="font-size: 10.97px;">多重背包</a> <a href="/tags/多重集组合数/" style="font-size: 10px;">多重集组合数</a> <a href="/tags/大数据/" style="font-size: 10.65px;">大数据</a> <a href="/tags/字典序最小/" style="font-size: 10px;">字典序最小</a> <a href="/tags/字符串/" style="font-size: 12.9px;">字符串</a> <a href="/tags/字符串匹配/" style="font-size: 10px;">字符串匹配</a> <a href="/tags/完全背包/" style="font-size: 10px;">完全背包</a> <a href="/tags/宽搜/" style="font-size: 10.32px;">宽搜</a> <a href="/tags/小程序/" style="font-size: 10px;">小程序</a> <a href="/tags/尺取法/" style="font-size: 10.32px;">尺取法</a> <a href="/tags/左式堆/" style="font-size: 10px;">左式堆</a> <a href="/tags/带括号带逗号的恶心输入/" style="font-size: 10px;">带括号带逗号的恶心输入</a> <a href="/tags/带权并查集/" style="font-size: 10px;">带权并查集</a> <a href="/tags/平方分割/" style="font-size: 10px;">平方分割</a> <a href="/tags/平衡查找树/" style="font-size: 10px;">平衡查找树</a> <a href="/tags/平面最近点对/" style="font-size: 10.97px;">平面最近点对</a> <a href="/tags/并发/" style="font-size: 16.77px;">并发</a> <a href="/tags/并查集/" style="font-size: 13.87px;">并查集</a> <a href="/tags/康托展开/" style="font-size: 11.29px;">康托展开</a> <a href="/tags/弹性碰撞/" style="font-size: 10.32px;">弹性碰撞</a> <a href="/tags/强连通/" style="font-size: 10.32px;">强连通</a> <a href="/tags/强连通分支/" style="font-size: 10.32px;">强连通分支</a> <a href="/tags/归并排序/" style="font-size: 10px;">归并排序</a> <a href="/tags/归并树/" style="font-size: 10px;">归并树</a> <a href="/tags/心语/" style="font-size: 10px;">心语</a> <a href="/tags/快排/" style="font-size: 10.65px;">快排</a> <a href="/tags/快速幂/" style="font-size: 12.9px;">快速幂</a> <a href="/tags/性能优化/" style="font-size: 10px;">性能优化</a> <a href="/tags/感悟/" style="font-size: 10px;">感悟</a> <a href="/tags/手工扩栈/" style="font-size: 10px;">手工扩栈</a> <a href="/tags/扩展KMP/" style="font-size: 10.65px;">扩展KMP</a> <a href="/tags/扩展欧几里得/" style="font-size: 10.65px;">扩展欧几里得</a> <a href="/tags/抓包/" style="font-size: 10px;">抓包</a> <a href="/tags/折半枚举/" style="font-size: 10px;">折半枚举</a> <a href="/tags/拓扑排序/" style="font-size: 12.58px;">拓扑排序</a> <a href="/tags/排序/" style="font-size: 15.81px;">排序</a> <a href="/tags/搜索/" style="font-size: 13.55px;">搜索</a> <a href="/tags/操作系统/" style="font-size: 10.97px;">操作系统</a> <a href="/tags/教材/" style="font-size: 19.03px;">教材</a> <a href="/tags/数学/" style="font-size: 15.16px;">数学</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数组/" style="font-size: 10px;">数组</a> <a href="/tags/数论/" style="font-size: 11.94px;">数论</a> <a href="/tags/方差优化/" style="font-size: 10px;">方差优化</a> <a href="/tags/暴力/" style="font-size: 10px;">暴力</a> <a href="/tags/最大公约数/" style="font-size: 10px;">最大公约数</a> <a href="/tags/最大流/" style="font-size: 11.94px;">最大流</a> <a href="/tags/最大流算法的优化/" style="font-size: 10px;">最大流算法的优化</a> <a href="/tags/最大流算法重弧和自环不会影响算法的正确性而只会影响效率/" style="font-size: 10px;">最大流算法重弧和自环不会影响算法的正确性而只会影响效率</a> <a href="/tags/最大生成树/" style="font-size: 10.32px;">最大生成树</a> <a href="/tags/最小正整数解/" style="font-size: 10.32px;">最小正整数解</a> <a href="/tags/最小生成树/" style="font-size: 11.29px;">最小生成树</a> <a href="/tags/最短路/" style="font-size: 12.9px;">最短路</a> <a href="/tags/最短路径/" style="font-size: 11.94px;">最短路径</a> <a href="/tags/最长回文子串/" style="font-size: 10px;">最长回文子串</a> <a href="/tags/有向图/" style="font-size: 10px;">有向图</a> <a href="/tags/机器学习/" style="font-size: 10px;">机器学习</a> <a href="/tags/杂/" style="font-size: 10px;">杂</a> <a href="/tags/板子/" style="font-size: 10px;">板子</a> <a href="/tags/查找/" style="font-size: 10px;">查找</a> <a href="/tags/查找树/" style="font-size: 12.58px;">查找树</a> <a href="/tags/栈/" style="font-size: 11.94px;">栈</a> <a href="/tags/树/" style="font-size: 17.42px;">树</a> <a href="/tags/树堆/" style="font-size: 10px;">树堆</a> <a href="/tags/树形dp/" style="font-size: 10.32px;">树形dp</a> <a href="/tags/树排/" style="font-size: 10px;">树排</a> <a href="/tags/树状数组/" style="font-size: 11.29px;">树状数组</a> <a href="/tags/树的直径/" style="font-size: 10.65px;">树的直径</a> <a href="/tags/桶排序/" style="font-size: 10px;">桶排序</a> <a href="/tags/模块化/" style="font-size: 10px;">模块化</a> <a href="/tags/模拟/" style="font-size: 10.65px;">模拟</a> <a href="/tags/模拟退火/" style="font-size: 10px;">模拟退火</a> <a href="/tags/模板/" style="font-size: 12.26px;">模板</a> <a href="/tags/次短路/" style="font-size: 10px;">次短路</a> <a href="/tags/欧几里得/" style="font-size: 10.32px;">欧几里得</a> <a href="/tags/欧拉函数/" style="font-size: 10.32px;">欧拉函数</a> <a href="/tags/欧拉回路/" style="font-size: 12.58px;">欧拉回路</a> <a href="/tags/欧拉环游/" style="font-size: 10px;">欧拉环游</a> <a href="/tags/欧拉环路/" style="font-size: 10px;">欧拉环路</a> <a href="/tags/死锁/" style="font-size: 10px;">死锁</a> <a href="/tags/泛洪/" style="font-size: 10px;">泛洪</a> <a href="/tags/洛谷/" style="font-size: 12.26px;">洛谷</a> <a href="/tags/洪特规则/" style="font-size: 10px;">洪特规则</a> <a href="/tags/浮点数二分答案/" style="font-size: 10px;">浮点数二分答案</a> <a href="/tags/深搜/" style="font-size: 11.29px;">深搜</a> <a href="/tags/源码/" style="font-size: 18.06px;">源码</a> <a href="/tags/源码分析/" style="font-size: 10.97px;">源码分析</a> <a href="/tags/滚动数组/" style="font-size: 10px;">滚动数组</a> <a href="/tags/版本控制/" style="font-size: 10px;">版本控制</a> <a href="/tags/牛客网/" style="font-size: 10.97px;">牛客网</a> <a href="/tags/牛顿迭代法/" style="font-size: 10px;">牛顿迭代法</a> <a href="/tags/状态压缩/" style="font-size: 10.65px;">状态压缩</a> <a href="/tags/状态压缩DP/" style="font-size: 10px;">状态压缩DP</a> <a href="/tags/生成树/" style="font-size: 10.32px;">生成树</a> <a href="/tags/百练/" style="font-size: 10.65px;">百练</a> <a href="/tags/矩阵快速幂/" style="font-size: 10.97px;">矩阵快速幂</a> <a href="/tags/离散化/" style="font-size: 10.97px;">离散化</a> <a href="/tags/空间复杂度优化/" style="font-size: 10px;">空间复杂度优化</a> <a href="/tags/筛法/" style="font-size: 11.61px;">筛法</a> <a href="/tags/简历/" style="font-size: 10px;">简历</a> <a href="/tags/算法/" style="font-size: 20px;">算法</a> <a href="/tags/精确匹配/" style="font-size: 10px;">精确匹配</a> <a href="/tags/精确覆盖/" style="font-size: 10px;">精确覆盖</a> <a href="/tags/素数/" style="font-size: 10px;">素数</a> <a href="/tags/素数测试/" style="font-size: 10.65px;">素数测试</a> <a href="/tags/约瑟夫环/" style="font-size: 10px;">约瑟夫环</a> <a href="/tags/线上问题/" style="font-size: 10px;">线上问题</a> <a href="/tags/线性同余方程/" style="font-size: 10px;">线性同余方程</a> <a href="/tags/线性筛/" style="font-size: 10px;">线性筛</a> <a href="/tags/线段树/" style="font-size: 13.23px;">线段树</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a> <a href="/tags/编译原理/" style="font-size: 13.55px;">编译原理</a> <a href="/tags/缩点/" style="font-size: 10.97px;">缩点</a> <a href="/tags/缩点重构DAG/" style="font-size: 10.32px;">缩点重构DAG</a> <a href="/tags/网络协议/" style="font-size: 10px;">网络协议</a> <a href="/tags/网络流/" style="font-size: 11.94px;">网络流</a> <a href="/tags/网络流建图/" style="font-size: 10px;">网络流建图</a> <a href="/tags/背包/" style="font-size: 13.87px;">背包</a> <a href="/tags/胜者树/" style="font-size: 10px;">胜者树</a> <a href="/tags/自己动手用java写编译器/" style="font-size: 13.55px;">自己动手用java写编译器</a> <a href="/tags/菜鸟教材/" style="font-size: 10.65px;">菜鸟教材</a> <a href="/tags/蓝桥杯/" style="font-size: 10px;">蓝桥杯</a> <a href="/tags/计算几何/" style="font-size: 11.61px;">计算几何</a> <a href="/tags/记忆化搜索/" style="font-size: 10.65px;">记忆化搜索</a> <a href="/tags/设计模式/" style="font-size: 10.65px;">设计模式</a> <a href="/tags/词典/" style="font-size: 10px;">词典</a> <a href="/tags/负权环/" style="font-size: 10.32px;">负权环</a> <a href="/tags/败者树/" style="font-size: 10px;">败者树</a> <a href="/tags/贪心/" style="font-size: 15.16px;">贪心</a> <a href="/tags/轮播图/" style="font-size: 10px;">轮播图</a> <a href="/tags/边bcc/" style="font-size: 10.65px;">边bcc</a> <a href="/tags/连通/" style="font-size: 10.97px;">连通</a> <a href="/tags/连通分支/" style="font-size: 10.32px;">连通分支</a> <a href="/tags/连通性/" style="font-size: 11.29px;">连通性</a> <a href="/tags/逆元/" style="font-size: 10px;">逆元</a> <a href="/tags/逆序数/" style="font-size: 10.32px;">逆序数</a> <a href="/tags/递归/" style="font-size: 11.29px;">递归</a> <a href="/tags/递归转栈/" style="font-size: 10px;">递归转栈</a> <a href="/tags/遍历/" style="font-size: 10px;">遍历</a> <a href="/tags/邻接多重表/" style="font-size: 10.65px;">邻接多重表</a> <a href="/tags/邻接链表法/" style="font-size: 10px;">邻接链表法</a> <a href="/tags/重复覆盖/" style="font-size: 10px;">重复覆盖</a> <a href="/tags/链表/" style="font-size: 11.29px;">链表</a> <a href="/tags/锁/" style="font-size: 10.65px;">锁</a> <a href="/tags/队列/" style="font-size: 11.29px;">队列</a> <a href="/tags/集合/" style="font-size: 10px;">集合</a> <a href="/tags/静态查找树/" style="font-size: 10.32px;">静态查找树</a> <a href="/tags/非递归/" style="font-size: 10px;">非递归</a> <a href="/tags/面试/" style="font-size: 14.19px;">面试</a> <a href="/tags/马踏棋盘/" style="font-size: 10px;">马踏棋盘</a> <a href="/tags/高精度/" style="font-size: 12.9px;">高精度</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/09/27/poj-2420-A-Star-not-a-Tree-费马点的求解-模拟退火/">poj 2420 A Star not a Tree? 费马点的求解 模拟退火</a>
          </li>
        
          <li>
            <a href="/2019/09/27/hdu-2899-Strange-fuction-三分/">hdu 2899 Strange fuction 三分</a>
          </li>
        
          <li>
            <a href="/2019/09/27/hihocoder-1142-三分·三分求极值-三分/">hihocoder 1142 : 三分·三分求极值 三分</a>
          </li>
        
          <li>
            <a href="/2019/09/26/poj-1698-Alice-s-Chance-EK-最大流/">poj 1698 Alice&#39;s Chance EK 最大流</a>
          </li>
        
          <li>
            <a href="/2019/09/26/uva-10735-Euler-Circuit-混合图的欧拉回路判断以及输出路径-最大流/">uva 10735 Euler Circuit 混合图的欧拉回路判断以及输出路径 最大流</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget tag">
    <h3 class="title">友情链接</h3>
      <ul class="entry">
        
          <li class="link"><a href="https://e99net.github.io/">99°</a></li>
        
      </ul>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>